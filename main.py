import json
import requests

def compute_similarity(vectors: list[list[float]]):
    with open("master_course.json", "r", encoding="UTF-8") as f:
        contents = json.load(f)

    counter = 0

    master = []

    for vector in vectors:
        for dict in contents["data"]:
            vectors = dict["vectors"]
            scores = []
            for v in vectors:
                similarity = cosine_similarity(v, vector)
                scores.append(similarity)
            master.append((counter, max(scores)))
            counter += 1

            #print(f"Processed {counter} entries in master_course.json, out of {len(contents['data'])}")

    #print("master_course.json processed")

    with open("master_discourse.json", "r", encoding="UTF-8") as f:
        contents2 = json.load(f)

    counter2 = 0

    master2 = []

    for vector in vectors:
        for dict in contents2["data"]:
            vectors = dict["vectors"]
            scores = []
            for v in vectors:
                similarity = cosine_similarity(v, vector)
                scores.append(similarity)
            master2.append((counter2, max(scores)))
            counter2 += 1

            #print(f"Processed {counter2} entries in master_discourse.json, out of {len(contents2['data'])}")

    #print("master_discourse.json processed")

    master.sort(key=lambda x: x[1], reverse=True)
    master2.sort(key=lambda x: x[1], reverse=True)

    master_text_and_url = [{"text": contents["data"][i[0] % len(contents)]["text"], "url": contents["data"][i[0] % len(contents)]["url"]} for i in master]
    master2_text_and_url = [{"text": contents2["data"][i[0] % len(contents)]["text"], "url": contents2["data"][i[0] % len(contents)]["url"]} for i in master2]

    ret = master_text_and_url[:3] + master2_text_and_url[:3]

    with open("similarity_results.log", "w", encoding="UTF-8") as f:
        f.write(str(ret))

    return ret


def cosine_similarity(vec1, vec2):
    dot_product = sum(a * b for a, b in zip(vec1, vec2))
    mag1 = sum(a * a for a in vec1) ** 0.5
    mag2 = sum(b * b for b in vec2) ** 0.5
    if mag1 == 0 or mag2 == 0:
        return 0
    return dot_product / (mag1 * mag2)

def fresh_prompt(question, li):

    results = compute_similarity(li)

    context = ""
    for result in results:
        context += result["text"]
    #return results

    AIPIPE_TOKEN = "eyJhbGciOiJIUzI1NiJ9.eyJlbWFpbCI6IjI0ZjEwMDE4MjRAZHMuc3R1ZHkuaWl0bS5hYy5pbiJ9.6sV4a8Mz_C3YcDH6AbamRY6crXiY6XHT7Zidb7z7zBA"

    headers = {
            "Authorization": f"{AIPIPE_TOKEN}",
            "Content-Type": "application/json"
    }

    with open("response_template.json", "r", encoding="UTF-8") as f:
        output = json.load(f)

    output["messages"][0]["content"] += context
    output["messages"][1]["content"] = question

    response = requests.post("https://aipipe.org/openai/v1/chat/completions", headers=headers, json=output)

    #return response.json()

    answer = response.json()["choices"][0]["message"]["content"]

    if "I don't know" in answer:
        ret = {"answer" : answer}
    else:
        ret = {"answer" : answer, "links": results}

    return ret


if __name__ == "__main__":

    li = [
        [0.033350933,0.037154887,-0.09017432,-0.13210626,-0.05882857,-0.020228771,-0.104564466,0.076197006,-0.10356188,-0.17633827,0.012642982,-0.099905364,-0.12455733,0.011691994,0.026067397,-0.04626668,0.16277379,0.0673506,0.035857413,-0.0700635,-0.025684053,0.06275047,0.03653564,0.018813347,-0.041725527,0.11500322,0.035739463,-0.012510287,-0.04287556,0.053579707,0.055348985,0.005753847,0.12974723,-0.14166038,-0.024976341,0.024725692,-0.07761243,0.13540892,-0.15003496,0.10149772,-0.030579062,-0.10745429,-0.09772325,0.007755345,-0.097782224,-0.023855796,0.026126374,0.05526052,-0.12774204,-0.028780293,-0.053284824,-0.031670116,0.123377815,0.031080358,0.080679186,-0.008278757,0.038511336,0.015967755,-0.11081593,-0.0074236053,-0.038363896,0.076904714,-0.03960239,0.08115099,0.022440372,0.044556376,0.045942314,0.017840244,0.042669144,-0.10786712,-0.027703982,0.025595589,-0.044261497,-0.09825403,-0.037125397,0.012989466,0.03473687,-0.014714515,0.03532663,-0.037184376,-0.030873941,-0.020936484,0.05912345,0.011994246,-0.03119831,-0.0005538216,0.005160401,0.018887067,0.07778936,-0.018577443,0.048301354,0.051545035,0.049893703,-0.08993842,0.01186155,-0.014139499,0.0040804027,-0.020494163,-0.104505494,-0.07566622,0.016100451,0.011065374,-0.097487345,-0.014257451,-0.0023535115,-0.004220471,0.04626668,-0.07820219,-0.046384633,-0.0149430465,0.07548929,0.043023,-0.011175954,0.06086324,-0.009111794,0.043052487,-0.019388363,-0.01701458,-0.054877177,-0.015156834,-0.078438096,-0.007548929,-0.023914773,0.12644456,0.055938747,-0.064932585,0.015016766,0.100259215,0.046178218,-0.01988966,0.07495851,0.008168178,0.07307128,-0.022558324,-0.07254049,-0.0012384963,-0.04833084,0.0016955603,-0.0005068251,-0.011728854,0.008979098,0.07672779,0.05393356,0.015967755,-0.06280945,-0.037626695,-0.025300708,0.034559943,0.032289367,0.019063996,-0.029222613,0.032702196,0.01551069,0.03149319,0.040457543,0.035651,-0.04667951,0.0016974033,0.0029322135,-0.029989302,-0.020965971,0.031699605,0.01624789,-0.00051926536,-0.009672066,-0.009819506,-0.030372646,-0.028278997,-0.02880978,0.042934537,0.02210126,0.044290982,0.0018946043,0.037597205,-0.005178831,-0.0042941906,0.02689306,-0.006000809,-0.0034077077,0.030638037,0.015304275,0.02129034,-0.012060594,-0.015304275,0.07566622,0.0065205353,-0.035090726,-0.028411694,0.033793256,0.009642578,0.048773162,-0.008639986,-0.023177572,0.03886519,0.027468078,0.019845428,-0.0088906335,-0.07318923,0.052164283,0.04732825,-0.021762148,-0.0016845023,0.01580557,-0.009001214,-0.0096573215,0.01959478,-0.043406345,0.009229746,-0.019462084,-0.01996338,0.008698962,0.045617945,-0.004489549,0.06959169,-0.053550217,-0.048242375,-0.0043826546,0.004607501,-0.006900193,-0.020833276,-0.018872323,0.012473426,-0.030991893,0.08421774,-0.006789613,0.010210222,0.013461274,0.04803596,-0.020494163,-0.012208034,-0.037331816,-0.102087475,0.042757608,0.032908615,-0.013343322,-0.059801675,0.05083732,0.014810351,-0.01775178,0.01605622,0.008241897,0.018046658,-0.053432267,-0.011175954,-0.035592023,0.0090675615,-0.008514661,-0.042049896,-0.024740437,0.051191177,0.02165894,-0.049716778,-0.047711592,-0.050129607,0.043052487,-0.018253075,0.053550217,0.032879125,-0.008610497,-0.01296735,0.031080358,0.051161688,0.027305894,0.0015444342,-0.0178255,-0.027836677,0.028441181,0.047593642,0.010401893,-0.031404726,0.040634472,0.008234525,-0.0002151703,0.025507124,0.049480874,-0.0015693147,0.028573876,-0.033527862,0.02773347,-0.012613494,-0.009937458,-0.00976053,0.031080358,-0.011301278,-0.0016172328,-0.009826878,-0.027939886,0.040015224,-0.025285965,-0.053019434,-0.0029727595,-0.038806215,-0.0031607456,0.003977195,0.02106918,0.0030391077,-0.0149430465,0.0017232053,0.029664934,0.026200093,-0.022705764,0.026111629,0.013085302,0.0014320113,0.012355474,0.0075636734,-0.041637063,-0.018105635,-0.006111389,0.045558967,-0.044379447,0.017324204,-0.0008680532,0.010696774,0.044910233,-0.00067407737,-0.032141928,-0.00043448733,0.04803596,0.022484604,0.01649854,0.033321448,0.016174171,0.0004874736,-0.016454307,-0.021260852,-0.017899219,-0.018916555,-0.008809541,0.015702363,-0.005016647,0.029222613,-0.01064517,0.022808973,-0.022292932,0.017707547,-0.045735896,-0.023089109,-0.0090675615,0.0036638847,-0.010512474,0.014286938,-0.0022539895,0.05296046,0.04688593,0.005370503,0.01440489,0.022219213,-0.049864218,-0.0033653185,-0.011028514,-0.04364225,0.02276474,-0.006148249,0.010704146,0.020346723,-0.02706999,0.0010551177,0.004743883,0.0034279807,0.0023369244,-0.01182469,-0.022676276,0.06917886,0.010822098,0.008558894,-0.0008823364,-0.0024825213,-0.00054230285,-0.022366652,0.0030004045,0.013476019,-0.018592188,0.0005404598,0.0067748693,-0.0034206086,0.013372811,0.037125397,0.0114855785,0.013254859,0.01988966,-0.03444199,-0.022661531,-0.018872323,-0.02423914,0.03397018,0.0024346034,-0.0008316539,0.050925784,-0.03340991,0.016410075,0.020420443,0.04579487,-0.010519846,0.027910396,-0.01875437,0.01683765,0.033881716,-0.025330197,0.00071139814,-0.012237522,0.012001618,-0.012053222,0.03296759,-0.050070632,0.049923193,-0.0018024544,-0.013579226,0.017869731,-0.022381395,-0.037331816,0.0018393144,-0.005628523,-0.0005031391,-0.040310103,0.0098342495,-0.0105419615,-0.0036233386,0.035975367,0.016292123,-0.041755017,-0.039160073,-0.0415486,-0.017176762,0.026996268,0.023531428,0.011190698,0.0015103387,0.0021452524,-0.011986874,-0.019580036,0.0076226494,-0.015016766,-0.017737035,0.006553709,0.0363882,0.00824927,0.023531428,-0.009023329,0.02824951,0.0052120048,-0.025020573,0.021054436,0.0010108857,0.011168582,-0.026730876,0.030903429,0.029561725,-0.018105635,-0.051987354,-0.023988493,-0.019506315,0.023885284,-0.0011795202,0.026671901,-0.032436807,-0.037125397,0.024062213,0.029075174,-0.0034003356,-0.005676441,0.0045816987,-0.048242375,-0.010667286,0.0033155575,0.009694181,0.030490598,0.0017877104,0.0103060575,0.03355735,0.0016550143,-0.02544815,0.018547956,-0.0018540584,-0.05823881,-0.020803787,-0.017545363,-0.03402916,-0.046797466,0.0016457993,-0.0011269947,0.015554923,0.059447818,-0.05484769,0.056734923,-0.016881883,-0.013041071,-0.005422107,-0.016100451,-0.0038260687,0.06298638,0.013394927,0.01590878,0.008160805,0.055555403,-0.018872323,-0.03060855,0.044526886,-0.0073572574,0.02541866,0.005274667,0.023796821,-0.03046111,0.03547407,-0.003966137,-0.06906091,-0.013645574,-0.0042389007,0.02305962,0.05823881,0.005219377,-0.0145891905,-0.020671092,0.005488455,0.007696369,-0.035385605,0.0005556646,-0.029075174,0.01657226,-0.014832467,0.015348507,0.0026557634,0.017633827,-0.01683765,0.005326271,0.023207061,0.005849683,0.020951228,0.0012090083,-0.022233956,-0.006089273,-0.00089293363,-0.018208843,0.018724883,-0.014544958,0.025625076,0.023973748,0.0019240923,0.0063730953,-0.0035588336,-0.011625646,-0.026745621,-0.0030925546,-0.010704146,-0.0048176027,-0.028234765,0.01885758,0.0022779484,-0.0019498944,0.020243516,-0.026185349,-0.0218801,0.010512474,-0.013195883,-0.012362846,0.00093946944,-0.026067397,0.0043163067,0.013092674,-0.01094005,0.007843809,-0.0064210133,0.0045337807,0.006653231,0.018046658,0.04570641,-0.020803787,-0.008647357,0.0006432071,0.029089916,0.045912825,-0.015436971,-0.015392738,0.006645859,-0.005613779,0.037272837,0.005256237,0.030726502,-0.020965971,-0.0076447655,0.059919626,-0.023162829,-0.017412666,0.021688428,-0.0009122852,-0.01171411,0.010224965,-0.029886093,-0.010409266,0.008418825,-0.016159426,-0.00891275,-0.0022779484,-0.030121997,-0.012348102,0.006476303,-0.018665908,0.015997242,-0.005189889,0.011338138,-0.015776083,-0.009922714,-0.0011629332,-0.026126374,-0.014139499,-0.00019720104,-0.022514092,-0.0103060575,0.011411858,0.005289411,-0.023103852,0.0025562414,0.022263443,-0.008492545,-0.0019517373,-0.0025857294,0.015451714,-0.0021857985,0.022086516,0.004924497,-0.005444223,-0.013284346,-0.011522438,0.0065315934,0.047239784,0.0073572574,-0.042020407,-0.014677655,0.05027705,-0.022823716,0.005517943,0.004555897,0.008588381,-0.029959813,0.0408114,-0.03264322,-0.013667691,0.013041071,-0.0016633078,-0.00078788266,0.011655134,0.0067158933,-0.010822098,-0.004231529,-0.0020273004,0.024843644,0.00072614214,0.0043863407,-0.026598182,0.017884476,-0.00090675615,-0.019285155,-0.00008258945,-0.023988493,0.023162829,0.0027515995,0.010107013,0.006148249,0.008794798,0.011706738,-0.027394356,-0.010475614,-0.01064517,-0.03284964,0.041489623,-0.0029064114,0.016336355,0.011868922,-0.021909587,-0.02180638,-0.0069149374,-0.010394522,-0.012097455,-0.00047918007,-0.0067564393,-0.0026870945,0.0026944664,0.030785477,0.007143469,-0.01959478,-0.01399943,-0.011441346,-0.014087895,-0.011286534,-0.018975532,-0.021865357,0.018828092,-0.01097691,0.015451714,-0.028043093,0.0030004045,-0.0036233386,-0.0015905093,0.013055814,-0.01595301,0.031168822,0.01841526,0.02765975,-0.0074752094,-0.02165894,0.018046658,0.008205038,-0.021246107,0.02541866,0.013601342,0.048419304,-0.0012126942,-0.028234765,0.005057193,-0.01812038,0.025875725,-0.020228771,-0.016926115,0.01204585,-0.030932918,-0.0029561725,-0.020287748,0.011316022,0.005197261,0.0025488695,-0.010954794,0.005285725,0.02942903,0.014441751,0.004865521,-0.027099477,0.022587812,-0.0032344656,-0.009937458,-0.004585385,0.014758747,0.0027497564,0.004095147,-0.031257287,0.008160805,-0.008794798,-0.0025120093,-0.008721078,-0.0030243637,0.019063996,0.027939886,-0.016734444,-0.024563508,-0.03402916,0.006240399,0.010475614,0.007932274,-0.004290505,-0.0065500233,0.021629453,0.006513163,-0.0017333418,0.0120753385,-0.0489206,0.009863738,0.004850777,-0.0015840587,0.004703337,-0.023973748,0.01885758,-0.048566744,0.0029561725,-0.01440489,0.022233956,-0.015245299,-0.009141281,0.0015471987,0.034766357,-0.010777866,-0.012871514,-0.003955079,-0.0037486628,0.018149868,-0.00014052878,-0.0009555957,0.012724075,-0.015938267,0.008816914,-0.0017361064,-0.008227154,0.0023203373,-0.0032602677,-0.0027939884,-0.008042853,-0.014338543,-0.007548929,-0.0075231274,0.0038297547,-0.004983473,0.0051124827,0.0025249105,-0.005739103,-0.010446126,0.008404082,0.012421822,-0.0044047707,-0.0005326271,0.0023737843,-0.005794393,0.02799886,0.010630426,-0.0015610213,-0.0047881147,0.0000904222,-0.012923119,0.017737035,0.011500322,0.02276474,-0.009531998,-0.0121932905,0.01900502,-0.005621151,0.005370503,-0.0036860006,0.0019591094,0.015820315,0.0024180165,0.009524626,-0.013107418,-0.0070439475,0.014051034,0.0018218058,-0.016660724,0.005532687,0.01226701,0.011809946,-0.01281991,-0.02129034,0.005060879,-0.0077995774,-0.0011463462,-0.008706333,0.0027386984,0.006494733,-0.013734039,0.009310838,-0.0032879126,0.005341015,-0.02092174,0.034353524,0.011175954,0.009568858,-0.016159426,0.0019683244,0.012495542,0.0034537825,0.004401085,-0.011515066,0.011190698,-0.0014255608,0.006151935,-0.03739079,0.0010763122,-0.0024180165,0.00021067797,-0.012451311,0.005337329,0.013652947,-0.017368436,0.005731731,-0.01204585,-0.008861146,0.0024991084,0.010519846,0.004850777,0.0000977942,0.010099642,-0.004496921,-0.032141928,0.004132007,0.0028308486,-0.006258829,0.004566955,-0.0069333673,-0.014559703,0.009237118,-0.0038961028,0.0018116693,0.0030483226,-0.005189889,-0.01053459,-0.009996434,0.0039108465,0.005646953,0.004732825,0.012768306,0.01138237,0.011758342,0.022410884,0.008411453,-0.01812038,0.004780743,0.009694181,0.005042449,0.007961761,-0.004496921,-0.011610902,0.005422107,-0.0040103686,0.013837246,-0.006317805,0.0020143993,0.01834154,0.0029782886,-0.0030409505,0.005757533,0.008920122,0.009222373,0.0005750161,0.008396709,0.012451311,-0.0115445545,-0.0015167893,-0.012348102,-0.0049650427,-0.0029322135,-0.016144684,-0.01311479,-0.012001618,0.009546742,-0.006059785,-0.0060487273,0.010689402,-0.004555897,0.0072356192,0.009141281,-0.015112603,-0.014950419,-0.006741695,0.01105063,0.005938147,-0.00021298173,-0.0008076949,0.0032455237,-0.0017655944,0.0093034655,0.0033653185,-0.000055433993,-0.0033450455,0.012451311,0.005075623,0.007880669,0.0024327605,-0.008979098,-0.0017232053,0.003947707,0.0012053222,-0.005591663,0.0020715324,0.01071889,-0.011153838,-0.0015324547,-0.006848589,-0.017294714,-0.00011944946,0.0005095896,0.0025083234,-0.014309054,-0.008020737,-0.0040398566,-0.016100451,-0.0075415573,0.009701554,0.007607905,-0.0118984105,0.0030151485,0.017515875,-0.014640795,0.012996838,0.016955603,0.0007353571,0.0032492096,-0.024135932,0.014390146,-0.0077922055,0.025595589,0.0074383495,0.0041098907,-0.01082947,-0.005164087,0.005105111,-0.010814726,0.0065389653,0.006841217,0.006011867,-0.028234765,-0.0010836842,0.018223587,0.007136097,-0.0006284631,0.006881763,0.0017923178,-0.005458967,-0.0067380094,-0.0069333673,-0.009694181,0.0036694137,-0.033321448,0.0021599964,0.008404082,-0.011478206,0.007313025,0.00022853204,0.026435997,-0.0006515006,-0.0091265375,0.0032860695,0.00004377126,0.0018595874,-0.007932274,0.027895654,0.005189889,0.006631115,-0.0021157644,-0.0050240187,-0.008735822,0.0026963095,0.014139499,-0.013247486,-0.0019664813,-0.005318899,0.016365843,-0.0076889973,0.0025728284]
        ]
    
    res = compute_similarity(li)

    with open("similarity_results.log", "w", encoding="UTF-8") as f:
        f.write(str(res))